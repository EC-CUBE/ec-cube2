name: PHPStan
run-name: PHPStan

on:
  workflow_call:
    inputs:
      ref_name:
        required: false
        type: string
      base_ref:
        required: false
        type: string
      event_name:
        required: true
        type: string
      owner:
        required: true
        type: string
jobs:
  phpstan:
    name: PHPStan
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
    - name: "Checkout"
      uses: actions/checkout@v4

    - name: Build docker image
      uses: ./.github/actions/dockerbuild
      with:
        php-version: '8.3'

    - name: Cache Composer dependencies
      uses: actions/cache@v4
      with:
        path: data/vendor
        key: ${{ runner.os }}-php8.3-vendor-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php8.3-vendor-

    - name: Restore vendor to docker volume
      run: |
        if [ -d "data/vendor" ] && [ "$(ls -A data/vendor 2>/dev/null)" ]; then
          echo "Restoring cached vendor to docker volume"
          # Get the volume name from docker-compose
          VOLUME_NAME=$(docker compose config --format json | jq -r '.volumes.vendor.name // "workspace-ec-cube2_vendor"')
          docker volume create $VOLUME_NAME
          docker run --rm -v ${VOLUME_NAME}:/target -v $(pwd)/data/vendor:/source alpine sh -c "cp -rp /source/. /target/"
        else
          echo "No cached vendor found, will install from scratch"
        fi

    - name: Setup environment
      env:
        REF_NAME: ${{ inputs.ref_name }}
        BASE_REF: ${{ inputs.base_ref }}
        EVENT_NAME: ${{ inputs.event_name }}
        OWNER: ${{ inputs.owner }}
      run: |
        echo "COMPOSE_FILE=docker-compose.yml:docker-compose.pgsql.yml:docker-compose.dev.yml" >> $GITHUB_ENV
        echo "IMAGE_NAME=${OWNER,,}/ec-cube2-php" >> $GITHUB_ENV
        if [ $EVENT_NAME = "pull_request" ]; then
          if [ -n $DOCKER_METADATA_OUTPUT_VERSION ]; then
            echo "TAG=${DOCKER_METADATA_OUTPUT_VERSION}" >> $GITHUB_ENV
          else
            echo "TAG=8.3-apache-${BASE_REF}" >> $GITHUB_ENV
          fi
        else
          echo "TAG=8.3-apache-${REF_NAME}" >> $GITHUB_ENV
        fi
    - run: |
        docker compose up -d --wait
        docker compose exec -T ec-cube composer install --no-progress --no-interaction --prefer-dist --optimize-autoloader

    - name: Save vendor from docker volume for caching
      if: always()
      run: |
        echo "Saving vendor from docker volume to host for caching"
        VOLUME_NAME=$(docker compose config --format json | jq -r '.volumes.vendor.name // "workspace-ec-cube2_vendor"')
        rm -rf data/vendor
        docker run --rm -v ${VOLUME_NAME}:/source -v $(pwd)/data/vendor:/target alpine sh -c "cp -rp /source/. /target/"

    - run: docker compose exec -T ec-cube php data/vendor/bin/phpstan --memory-limit=512M --no-progress analyze data/ --error-format=github
